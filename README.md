# 比赛代码查重插件

一个用于HydroOJ的比赛代码查重插件，帮助管理员检测比赛中的代码相似度，防止作弊行为。

## 功能特性

### 🎯 核心功能
- **比赛选择**：从所有比赛中选择需要查重的比赛
- **题目筛选**：灵活选择比赛中的特定题目进行查重
- **多语言支持**：支持C、C++、Python、Java等主流编程语言
- **智能分析**：基于代码相似度算法进行深度分析
- **可视化结果**：直观展示查重结果和相似代码片段

### 📊 查重算法
- **代码标准化**：自动移除注释、格式化代码
- **相似度计算**：基于编辑距离算法计算代码相似度
- **片段识别**：精确定位相似的代码片段
- **高亮显示**：在前端高亮显示相似的代码部分

### 🔍 查重流程
1. **选择比赛**：管理员在查重界面选择目标比赛
2. **选择题目**：从比赛题目中选择需要查重的题目（支持多选/全选）
3. **提交任务**：系统异步处理查重请求
4. **查看结果**：实时查看处理进度和详细结果

## 界面说明

### 路由结构
```
/plagiarism                           # 查重系统主界面
├── /contest                          # 比赛查重列表
├── /contest/:contestId/select        # 题目选择界面
├── /contest/:contestId               # 比赛查重总览
└── /contest/:contestId/:problemId    # 具体题目查重结果
```

### 主要界面

#### 1. 查重系统主界面 (`/plagiarism`)
- 显示系统统计信息（报告数量、完成状态等）
- 展示最近的查重报告
- 提供快速入口到比赛查重功能

#### 2. 比赛查重列表 (`/plagiarism/contest`)
- 展示所有已创建查重任务的比赛
- 支持新建查重任务
- 显示每个比赛的查重报告状态

#### 3. 题目选择界面 (`/plagiarism/contest/:contestId/select`)
- 显示比赛的所有题目
- 支持单选、多选、全选题目
- 验证至少选择一个题目

#### 4. 比赛查重总览 (`/plagiarism/contest/:contestId`)
- 显示该比赛所有查重报告
- 展示每个报告的处理状态和基本统计
- 提供到具体题目查重结果的链接

#### 5. 题目查重详情 (`/plagiarism/contest/:contestId/:problemId`)
- 按语言分组显示查重结果
- 详细展示相似代码对比
- 支持展开/收起代码片段
- 相似度可视化（进度条、圆环图）

## 技术实现

### 数据结构

#### 查重报告 (plagiarism_reports)
```typescript
interface PlagiarismReport {
    _id: ObjectId;
    contestId: ObjectId;        // 比赛ID
    problemIds: number[];       // 题目ID列表
    createdAt: Date;           // 创建时间
    createdBy: number;         // 创建者用户ID
    status: 'pending' | 'processing' | 'completed' | 'failed';
    results?: PlagiarismResult[];  // 查重结果
}
```

#### 查重结果
```typescript
interface PlagiarismResult {
    problemId: number;         // 题目ID
    language: string;          // 编程语言
    pairs: SimilarityPair[];   // 相似提交对
}

interface SimilarityPair {
    submission1: ObjectId;     // 提交1 ID
    submission2: ObjectId;     // 提交2 ID
    user1: number;             // 用户1 ID
    user2: number;             // 用户2 ID
    similarity: number;        // 相似度 (0-1)
    details: SimilarityDetail[]; // 相似片段详情
}
```

### 相似度算法

#### 1. 代码标准化
- 移除单行注释 (`//`、`#`)
- 移除多行注释 (`/* */`)
- 统一空格和换行符
- 去除多余的空行

#### 2. 相似度计算
- 使用Levenshtein编辑距离算法
- 计算两个代码字符串的最小编辑步数
- 转换为相似度百分比：`similarity = 1 - (distance / maxLength)`

#### 3. 代码片段识别
- 滑动窗口算法（默认5行）
- 对每个窗口计算相似度
- 筛选高于阈值的相似片段（默认70%）

### 语言分组策略

```javascript
// C语言：cc、c.*
// C++：cpp、cc17、cxx、cc17o2等
// Python：py、python3等  
// Java：java、java8等
// 其他：归类为other
```

## 安装配置

### 1. 基本安装
```bash
# 复制插件到HydroOJ插件目录
cp -r plagiarism-plugin /path/to/hydrooj/plugins/

# 安装依赖
cd /path/to/hydrooj/plugins/plagiarism-plugin
npm install

# 重启HydroOJ服务
pm2 restart hydrooj
```

### 2. 权限配置
- 需要 `PRIV.PRIV_EDIT_SYSTEM` 权限才能访问查重功能
- 确保管理员账户具备该权限

### 3. 数据库配置
插件会自动创建以下MongoDB集合：
- `plagiarism_reports`：存储查重报告

## 使用指南

### 管理员操作流程

#### 1. 创建查重任务
1. 访问 `/plagiarism/contest` 页面
2. 选择要查重的比赛
3. 点击"新建查重任务"
4. 在题目选择页面选择需要查重的题目
5. 提交任务，系统开始后台处理

#### 2. 查看查重结果
1. 在比赛查重总览页面查看任务状态
2. 等待任务完成（状态变为"已完成"）
3. 点击具体题目查看详细的查重结果
4. 分析相似代码片段，判断是否存在作弊行为

#### 3. 结果解读
- **相似度 > 80%**：高度相似，需要重点关注
- **相似度 60-80%**：中等相似，建议人工审核  
- **相似度 < 60%**：相似度较低，可能是正常现象

## 界面特色

### 🎨 美观设计
- 采用现代化卡片式布局
- 独特的CSS类名（`plagiarism-*`）避免样式冲突
- 响应式设计，支持移动端访问
- 丰富的交互动效和状态指示

### 📱 用户体验
- 直观的进度指示器
- 实时状态更新
- 代码片段语法高亮
- 可折叠的详情面板

### 🔧 技术优化
- 异步处理避免界面阻塞
- 分页显示大量数据
- 智能的语言识别和分组
- 高效的相似度算法

## 注意事项

### ⚠️ 使用限制
1. 只分析状态为AC（Accepted）的提交
2. 跳过同一用户的不同提交
3. 语言分组时至少需要2个提交才会进行查重
4. 相似度阈值可在代码中调整（默认60%）

### 🛡️ 隐私保护
- 只有具备管理权限的用户才能访问查重功能
- 代码内容仅用于相似度分析，不做其他用途
- 查重结果仅供管理员内部使用

### 📈 性能考虑
- 大型比赛查重可能需要较长时间
- 建议分批次进行题目查重
- 后台异步处理避免影响系统性能

## 扩展功能

### 🔮 未来规划
- [ ] 支持更多编程语言
- [ ] 优化相似度算法精度
- [ ] 添加查重报告导出功能
- [ ] 集成邮件通知功能
- [ ] 支持自定义相似度阈值

### 🛠️ 自定义配置
可在代码中调整以下参数：
- 相似度阈值（默认0.6）
- 代码片段窗口大小（默认5行）
- 分页数量（默认20条/页）

## 技术支持

如遇到问题或需要定制功能，请联系开发团队。

---

**版本**：1.0.0  
**兼容性**：HydroOJ 5.0.0-beta.5+  
**许可证**：AGPL-3.0
